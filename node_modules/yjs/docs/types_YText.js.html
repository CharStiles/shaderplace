

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: types/YText.js | yjs</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
        
            <link type="text/css" rel="stylesheet" href="./style.css">
        
    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 162px; height: 162px">
        
            <a href="/" rel="noopener noreferrer" target="_blank">
                <img src="https://yjs.dev/images/logo/yjs-512x512.png" width="100%" height="100%">
            </a>
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">yjs</a></h1>
        
            <span class="version">v13.4.11</span>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Modules</h3><ul><li><a href="module-encoding.html">encoding</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:encoding_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-encoding.html#.applyUpdate">applyUpdate</a></li><li><a href="module-encoding.html#.applyUpdateV2">applyUpdateV2</a></li><li><a href="module-encoding.html#.decodeStateVector">decodeStateVector</a></li><li><a href="module-encoding.html#.decodeStateVectorV2">decodeStateVectorV2</a></li><li><a href="module-encoding.html#.encodeStateAsUpdate">encodeStateAsUpdate</a></li><li><a href="module-encoding.html#.encodeStateAsUpdateV2">encodeStateAsUpdateV2</a></li><li><a href="module-encoding.html#.encodeStateVector">encodeStateVector</a></li><li><a href="module-encoding.html#.encodeStateVectorV2">encodeStateVectorV2</a></li><li><a href="module-encoding.html#.readStateVector">readStateVector</a></li><li><a href="module-encoding.html#.readUpdate">readUpdate</a></li><li><a href="module-encoding.html#.readUpdateV2">readUpdateV2</a></li><li><a href="module-encoding.html#.writeDocumentStateVector">writeDocumentStateVector</a></li><li><a href="module-encoding.html#.writeStateAsUpdate">writeStateAsUpdate</a></li><li><a href="module-encoding.html#.writeStateVector">writeStateVector</a></li><li><a href="module-encoding.html#~cleanupPendingStructs">cleanupPendingStructs</a></li><li><a href="module-encoding.html#~writeStructs">writeStructs</a></li></ul></div></li><li><a href="module-Y.html">Y</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:Y_sub"><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-Y.html#~DocOpts">DocOpts</a></li></ul></div></li><li><a href="module-YArray.html">YArray</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:YArray_sub"></div></li><li><a href="module-YMap.html">YMap</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:YMap_sub"></div></li><li><a href="module-YText.html">YText</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:YText_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-YText.html#.cleanupYTextFormatting">cleanupYTextFormatting</a></li><li><a href="module-YText.html#.parent">parent</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-YText.html#~cleanupContextlessFormattingGap">cleanupContextlessFormattingGap</a></li><li><a href="module-YText.html#~cleanupFormattingGap">cleanupFormattingGap</a></li><li><a href="module-YText.html#~equalAttrs">equalAttrs</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-YText.html#~DeltaItem">DeltaItem</a></li><li><a href="module-YText.html#~TextAttributes">TextAttributes</a></li></ul></div></li><li><a href="module-YXml.html">YXml</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:YXml_sub"><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-YXml.html#~CSS_Selector">CSS_Selector</a></li><li><a href="module-YXml.html#~domFilter">domFilter</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="AbsolutePosition_AbsolutePosition.html">AbsolutePosition</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="AbsolutePosition#AbsolutePosition_sub"></div></li><li><a href="AbstractConnector.html">AbstractConnector</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="AbstractConnector_sub"></div></li><li><a href="AbstractContent.html">AbstractContent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="AbstractContent_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="AbstractContent.html#copy">copy</a></li><li><a href="AbstractContent.html#delete">delete</a></li><li><a href="AbstractContent.html#gc">gc</a></li><li><a href="AbstractContent.html#getContent">getContent</a></li><li><a href="AbstractContent.html#getLength">getLength</a></li><li><a href="AbstractContent.html#getRef">getRef</a></li><li><a href="AbstractContent.html#integrate">integrate</a></li><li><a href="AbstractContent.html#isCountable">isCountable</a></li><li><a href="AbstractContent.html#mergeWith">mergeWith</a></li><li><a href="AbstractContent.html#splice">splice</a></li><li><a href="AbstractContent.html#write">write</a></li></ul></div></li><li><a href="AbstractDSDecoder_AbstractDSDecoder.html">AbstractDSDecoder</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="AbstractDSDecoder#AbstractDSDecoder_sub"></div></li><li><a href="AbstractStruct_AbstractStruct.html">AbstractStruct</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="AbstractStruct#AbstractStruct_sub"></div></li><li><a href="AbstractType.html">AbstractType</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="AbstractType_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="AbstractType.html#_dEH">_dEH</a></li><li><a href="AbstractType.html#_eH">_eH</a></li><li><a href="AbstractType.html#_first">_first</a></li><li><a href="AbstractType.html#_item">_item</a></li><li><a href="AbstractType.html#_map">_map</a></li><li><a href="AbstractType.html#_searchMarker">_searchMarker</a></li><li><a href="AbstractType.html#_start">_start</a></li><li><a href="AbstractType.html#doc">doc</a></li><li><a href="AbstractType.html#parent">parent</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="AbstractType.html#_callObserver">_callObserver</a></li><li><a href="AbstractType.html#_copy">_copy</a></li><li><a href="AbstractType.html#_integrate">_integrate</a></li><li><a href="AbstractType.html#_write">_write</a></li><li><a href="AbstractType.html#clone">clone</a></li><li><a href="AbstractType.html#observe">observe</a></li><li><a href="AbstractType.html#observeDeep">observeDeep</a></li><li><a href="AbstractType.html#toJSON">toJSON</a></li><li><a href="AbstractType.html#unobserve">unobserve</a></li><li><a href="AbstractType.html#unobserveDeep">unobserveDeep</a></li></ul></div></li><li><a href="ArraySearchMarker_ArraySearchMarker.html">ArraySearchMarker</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ArraySearchMarker#ArraySearchMarker_sub"></div></li><li><a href="ContentAny_ContentAny.html">ContentAny</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ContentAny#ContentAny_sub"></div></li><li><a href="ContentBinary_ContentBinary.html">ContentBinary</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ContentBinary#ContentBinary_sub"></div></li><li><a href="ContentDeleted_ContentDeleted.html">ContentDeleted</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ContentDeleted#ContentDeleted_sub"></div></li><li><a href="DeleteItem_DeleteItem.html">DeleteItem</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="DeleteItem#DeleteItem_sub"></div></li><li><a href="DeleteSet.html">DeleteSet</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="DeleteSet_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="DeleteSet.html#clients">clients</a></li></ul></div></li><li><a href="DSDecoderV1_DSDecoderV1.html">DSDecoderV1</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="DSDecoderV1#DSDecoderV1_sub"></div></li><li><a href="DSDecoderV2_DSDecoderV2.html">DSDecoderV2</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="DSDecoderV2#DSDecoderV2_sub"></div></li><li><a href="ID_ID.html">ID</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ID#ID_sub"></div></li><li><a href="Item.html">Item</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Item_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Item.html#content">content</a></li><li><a href="Item.html#deleted">deleted</a></li><li><a href="Item.html#info">info</a></li><li><a href="Item.html#keep">keep</a></li><li><a href="Item.html#lastId">lastId</a></li><li><a href="Item.html#left">left</a></li><li><a href="Item.html#marker">marker</a></li><li><a href="Item.html#next">next</a></li><li><a href="Item.html#origin">origin</a></li><li><a href="Item.html#parent">parent</a></li><li><a href="Item.html#parent">parent</a></li><li><a href="Item.html#parent">parent</a></li><li><a href="Item.html#parent">parent</a></li><li><a href="Item.html#parentSub">parentSub</a></li><li><a href="Item.html#prev">prev</a></li><li><a href="Item.html#redone">redone</a></li><li><a href="Item.html#right">right</a></li><li><a href="Item.html#rightOrigin">rightOrigin</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Item.html#delete">delete</a></li><li><a href="Item.html#gc">gc</a></li><li><a href="Item.html#getMissing">getMissing</a></li><li><a href="Item.html#integrate">integrate</a></li><li><a href="Item.html#mergeWith">mergeWith</a></li><li><a href="Item.html#write">write</a></li></ul></div></li><li><a href="module-Y.Doc.html">Doc</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:Y.Doc_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-Y.Doc.html#_item">_item</a></li><li><a href="module-Y.Doc.html#_transaction">_transaction</a></li><li><a href="module-Y.Doc.html#_transactionCleanups">_transactionCleanups</a></li><li><a href="module-Y.Doc.html#share">share</a></li><li><a href="module-Y.Doc.html#subdocs">subdocs</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-Y.Doc.html#destroy">destroy</a></li><li><a href="module-Y.Doc.html#get">get</a></li><li><a href="module-Y.Doc.html#getArray">getArray</a></li><li><a href="module-Y.Doc.html#getMap">getMap</a></li><li><a href="module-Y.Doc.html#getText">getText</a></li><li><a href="module-Y.Doc.html#getXmlFragment">getXmlFragment</a></li><li><a href="module-Y.Doc.html#load">load</a></li><li><a href="module-Y.Doc.html#off">off</a></li><li><a href="module-Y.Doc.html#on">on</a></li><li><a href="module-Y.Doc.html#toJSON">toJSON</a></li><li><a href="module-Y.Doc.html#transact">transact</a></li></ul></div></li><li><a href="module-YArray.YArray.html">YArray</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:YArray.YArray_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-YArray.YArray.html#_prelimContent">_prelimContent</a></li><li><a href="module-YArray.YArray.html#_searchMarker">_searchMarker</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-YArray.YArray.html#.from">from</a></li><li><a href="module-YArray.YArray.html#_callObserver">_callObserver</a></li><li><a href="module-YArray.YArray.html#_integrate">_integrate</a></li><li><a href="module-YArray.YArray.html#_write">_write</a></li><li><a href="module-YArray.YArray.html#clone">clone</a></li><li><a href="module-YArray.YArray.html#delete">delete</a></li><li><a href="module-YArray.YArray.html#forEach">forEach</a></li><li><a href="module-YArray.YArray.html#get">get</a></li><li><a href="module-YArray.YArray.html#insert">insert</a></li><li><a href="module-YArray.YArray.html#map">map</a></li><li><a href="module-YArray.YArray.html#push">push</a></li><li><a href="module-YArray.YArray.html#slice">slice</a></li><li><a href="module-YArray.YArray.html#Symbol.iterator">Symbol.iterator</a></li><li><a href="module-YArray.YArray.html#toArray">toArray</a></li><li><a href="module-YArray.YArray.html#toJSON">toJSON</a></li><li><a href="module-YArray.YArray.html#unshift">unshift</a></li></ul></div></li><li><a href="module-YArray.YArrayEvent.html">YArrayEvent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:YArray.YArrayEvent_sub"></div></li><li><a href="module-YMap.YMap.html">YMap</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:YMap.YMap_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-YMap.YMap.html#size">size</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-YMap.YMap.html#_callObserver">_callObserver</a></li><li><a href="module-YMap.YMap.html#_integrate">_integrate</a></li><li><a href="module-YMap.YMap.html#_write">_write</a></li><li><a href="module-YMap.YMap.html#clone">clone</a></li><li><a href="module-YMap.YMap.html#delete">delete</a></li><li><a href="module-YMap.YMap.html#entries">entries</a></li><li><a href="module-YMap.YMap.html#forEach">forEach</a></li><li><a href="module-YMap.YMap.html#get">get</a></li><li><a href="module-YMap.YMap.html#has">has</a></li><li><a href="module-YMap.YMap.html#keys">keys</a></li><li><a href="module-YMap.YMap.html#set">set</a></li><li><a href="module-YMap.YMap.html#Symbol.iterator">Symbol.iterator</a></li><li><a href="module-YMap.YMap.html#toJSON">toJSON</a></li><li><a href="module-YMap.YMap.html#values">values</a></li></ul></div></li><li><a href="module-YMap.YMapEvent.html">YMapEvent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:YMap.YMapEvent_sub"></div></li><li><a href="module-YText.ItemTextListPosition.html">ItemTextListPosition</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:YText.ItemTextListPosition_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-YText.ItemTextListPosition.html#forward">forward</a></li></ul></div></li><li><a href="module-YText.YText.html">YText</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:YText.YText_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-YText.YText.html#_pending">_pending</a></li><li><a href="module-YText.YText.html#_searchMarker">_searchMarker</a></li><li><a href="module-YText.YText.html#doc">doc</a></li><li><a href="module-YText.YText.html#length">length</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-YText.YText.html#_callObserver">_callObserver</a></li><li><a href="module-YText.YText.html#_integrate">_integrate</a></li><li><a href="module-YText.YText.html#_write">_write</a></li><li><a href="module-YText.YText.html#applyDelta">applyDelta</a></li><li><a href="module-YText.YText.html#clone">clone</a></li><li><a href="module-YText.YText.html#delete">delete</a></li><li><a href="module-YText.YText.html#format">format</a></li><li><a href="module-YText.YText.html#getAttribute">getAttribute</a></li><li><a href="module-YText.YText.html#getAttributes">getAttributes</a></li><li><a href="module-YText.YText.html#insert">insert</a></li><li><a href="module-YText.YText.html#insertEmbed">insertEmbed</a></li><li><a href="module-YText.YText.html#removeAttribute">removeAttribute</a></li><li><a href="module-YText.YText.html#setAttribute">setAttribute</a></li><li><a href="module-YText.YText.html#toDelta">toDelta</a></li><li><a href="module-YText.YText.html#toJSON">toJSON</a></li><li><a href="module-YText.YText.html#toString">toString</a></li></ul></div></li><li><a href="module-YText.YTextEvent.html">YTextEvent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:YText.YTextEvent_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-YText.YTextEvent.html#_delta">_delta</a></li><li><a href="module-YText.YTextEvent.html#_delta">_delta</a></li><li><a href="module-YText.YTextEvent.html#delta">delta</a></li><li><a href="module-YText.YTextEvent.html#keysChanged">keysChanged</a></li></ul></div></li><li><a href="module-YXml.YXmlFragment.html">YXmlFragment</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:YXml.YXmlFragment_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-YXml.YXmlFragment.html#_prelimContent">_prelimContent</a></li><li><a href="module-YXml.YXmlFragment.html#_prelimContent">_prelimContent</a></li><li><a href="module-YXml.YXmlFragment.html#_prelimContent">_prelimContent</a></li><li><a href="module-YXml.YXmlFragment.html#firstChild">firstChild</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-YXml.YXmlFragment.html#_callObserver">_callObserver</a></li><li><a href="module-YXml.YXmlFragment.html#_integrate">_integrate</a></li><li><a href="module-YXml.YXmlFragment.html#_write">_write</a></li><li><a href="module-YXml.YXmlFragment.html#clone">clone</a></li><li><a href="module-YXml.YXmlFragment.html#createTreeWalker">createTreeWalker</a></li><li><a href="module-YXml.YXmlFragment.html#delete">delete</a></li><li><a href="module-YXml.YXmlFragment.html#get">get</a></li><li><a href="module-YXml.YXmlFragment.html#insert">insert</a></li><li><a href="module-YXml.YXmlFragment.html#insertAfter">insertAfter</a></li><li><a href="module-YXml.YXmlFragment.html#push">push</a></li><li><a href="module-YXml.YXmlFragment.html#querySelector">querySelector</a></li><li><a href="module-YXml.YXmlFragment.html#querySelectorAll">querySelectorAll</a></li><li><a href="module-YXml.YXmlFragment.html#slice">slice</a></li><li><a href="module-YXml.YXmlFragment.html#toArray">toArray</a></li><li><a href="module-YXml.YXmlFragment.html#toDOM">toDOM</a></li><li><a href="module-YXml.YXmlFragment.html#toJSON">toJSON</a></li><li><a href="module-YXml.YXmlFragment.html#toString">toString</a></li><li><a href="module-YXml.YXmlFragment.html#unshift">unshift</a></li></ul></div></li><li><a href="module-YXml.YXmlTreeWalker.html">YXmlTreeWalker</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:YXml.YXmlTreeWalker_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-YXml.YXmlTreeWalker.html#_currentNode">_currentNode</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-YXml.YXmlTreeWalker.html#next">next</a></li></ul></div></li><li><a href="PermanentUserData_PermanentUserData.html">PermanentUserData</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="PermanentUserData#PermanentUserData_sub"></div></li><li><a href="RelativePosition.html">RelativePosition</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="RelativePosition_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="RelativePosition.html#assoc">assoc</a></li><li><a href="RelativePosition.html#item">item</a></li><li><a href="RelativePosition.html#tname">tname</a></li><li><a href="RelativePosition.html#type">type</a></li></ul></div></li><li><a href="Snapshot_Snapshot.html">Snapshot</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Snapshot#Snapshot_sub"></div></li><li><a href="StackItem.html">StackItem</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="StackItem_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="StackItem.html#meta">meta</a></li></ul></div></li><li><a href="Transaction.html">Transaction</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Transaction_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Transaction.html#_mergeStructs">_mergeStructs</a></li><li><a href="Transaction.html#afterState">afterState</a></li><li><a href="Transaction.html#beforeState">beforeState</a></li><li><a href="Transaction.html#changed">changed</a></li><li><a href="Transaction.html#changedParentTypes">changedParentTypes</a></li><li><a href="Transaction.html#deleteSet">deleteSet</a></li><li><a href="Transaction.html#doc">doc</a></li><li><a href="Transaction.html#local">local</a></li><li><a href="Transaction.html#meta">meta</a></li><li><a href="Transaction.html#origin">origin</a></li><li><a href="Transaction.html#subdocsAdded">subdocsAdded</a></li><li><a href="Transaction.html#subdocsLoaded">subdocsLoaded</a></li><li><a href="Transaction.html#subdocsRemoved">subdocsRemoved</a></li></ul></div></li><li><a href="UndoManager.html">UndoManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UndoManager_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="UndoManager.html#redoStack">redoStack</a></li><li><a href="UndoManager.html#undoing">undoing</a></li><li><a href="UndoManager.html#undoStack">undoStack</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="UndoManager.html#redo">redo</a></li><li><a href="UndoManager.html#stopCapturing">stopCapturing</a></li><li><a href="UndoManager.html#undo">undo</a></li></ul></div></li><li><a href="UpdateDecoderV2_UpdateDecoderV2.html">UpdateDecoderV2</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UpdateDecoderV2#UpdateDecoderV2_sub"></div></li><li><a href="YEvent.html">YEvent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="YEvent_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="YEvent.html#_changes">_changes</a></li><li><a href="YEvent.html#changes">changes</a></li><li><a href="YEvent.html#currentTarget">currentTarget</a></li><li><a href="YEvent.html#path">path</a></li><li><a href="YEvent.html#target">target</a></li><li><a href="YEvent.html#transaction">transaction</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="YEvent.html#adds">adds</a></li><li><a href="YEvent.html#deletes">deletes</a></li></ul></div></li><li><a href="YXmlElement.html">YXmlElement</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="YXmlElement_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="YXmlElement.html#_prelimAttrs">_prelimAttrs</a></li><li><a href="YXmlElement.html#_prelimAttrs">_prelimAttrs</a></li><li><a href="YXmlElement.html#nextSibling">nextSibling</a></li><li><a href="YXmlElement.html#prevSibling">prevSibling</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="YXmlElement.html#_copy">_copy</a></li><li><a href="YXmlElement.html#_integrate">_integrate</a></li><li><a href="YXmlElement.html#_write">_write</a></li><li><a href="YXmlElement.html#clone">clone</a></li><li><a href="YXmlElement.html#getAttribute">getAttribute</a></li><li><a href="YXmlElement.html#getAttributes">getAttributes</a></li><li><a href="YXmlElement.html#removeAttribute">removeAttribute</a></li><li><a href="YXmlElement.html#setAttribute">setAttribute</a></li><li><a href="YXmlElement.html#toDOM">toDOM</a></li><li><a href="YXmlElement.html#toString">toString</a></li></ul></div></li><li><a href="YXmlEvent.html">YXmlEvent</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="YXmlEvent_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="YXmlEvent.html#attributesChanged">attributesChanged</a></li></ul></div></li><li><a href="YXmlHook.html">YXmlHook</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="YXmlHook_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="YXmlHook.html#hookName">hookName</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="YXmlHook.html#_copy">_copy</a></li><li><a href="YXmlHook.html#_write">_write</a></li><li><a href="YXmlHook.html#clone">clone</a></li><li><a href="YXmlHook.html#toDOM">toDOM</a></li></ul></div></li><li><a href="YXmlText.html">YXmlText</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="YXmlText_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="YXmlText.html#nextSibling">nextSibling</a></li><li><a href="YXmlText.html#prevSibling">prevSibling</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="YXmlText.html#_write">_write</a></li><li><a href="YXmlText.html#clone">clone</a></li><li><a href="YXmlText.html#toDOM">toDOM</a></li><li><a href="YXmlText.html#toJSON">toJSON</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li><a href="global.html#addChangedTypeToTransaction">addChangedTypeToTransaction</a></li><li><a href="global.html#callTypeObservers">callTypeObservers</a></li><li><a href="global.html#cleanupTransactions">cleanupTransactions</a></li><li><a href="global.html#compareIDs">compareIDs</a></li><li><a href="global.html#compareRelativePositions">compareRelativePositions</a></li><li><a href="global.html#contentRefs">contentRefs</a></li><li><a href="global.html#createAbsolutePosition">createAbsolutePosition</a></li><li><a href="global.html#createAbsolutePositionFromRelativePosition">createAbsolutePositionFromRelativePosition</a></li><li><a href="global.html#createDocFromSnapshot">createDocFromSnapshot</a></li><li><a href="global.html#createRelativePosition">createRelativePosition</a></li><li><a href="global.html#createRelativePositionFromJSON">createRelativePositionFromJSON</a></li><li><a href="global.html#createRelativePositionFromTypeIndex">createRelativePositionFromTypeIndex</a></li><li><a href="global.html#createSnapshot">createSnapshot</a></li><li><a href="global.html#decodeRelativePosition">decodeRelativePosition</a></li><li><a href="global.html#decodeSnapshot">decodeSnapshot</a></li><li><a href="global.html#decodeSnapshotV2">decodeSnapshotV2</a></li><li><a href="global.html#encodeRelativePosition">encodeRelativePosition</a></li><li><a href="global.html#encodeSnapshot">encodeSnapshot</a></li><li><a href="global.html#encodeSnapshotV2">encodeSnapshotV2</a></li><li><a href="global.html#equalSnapshots">equalSnapshots</a></li><li><a href="global.html#findIndexCleanStart">findIndexCleanStart</a></li><li><a href="global.html#findMarker">findMarker</a></li><li><a href="global.html#followRedone">followRedone</a></li><li><a href="global.html#getState">getState</a></li><li><a href="global.html#getStateVector">getStateVector</a></li><li><a href="global.html#getTypeChildren">getTypeChildren</a></li><li><a href="global.html#globalSearchMarkerTimestamp">globalSearchMarkerTimestamp</a></li><li><a href="global.html#isVisible">isVisible</a></li><li><a href="global.html#iterateDeletedStructs">iterateDeletedStructs</a></li><li><a href="global.html#iterateStructs">iterateStructs</a></li><li><a href="global.html#keepItem">keepItem</a></li><li><a href="global.html#logType">logType</a></li><li><a href="global.html#markPosition">markPosition</a></li><li><a href="global.html#mergeDeleteSets">mergeDeleteSets</a></li><li><a href="global.html#overwriteMarker">overwriteMarker</a></li><li><a href="global.html#popStackItem">popStackItem</a></li><li><a href="global.html#readContentAny">readContentAny</a></li><li><a href="global.html#readContentBinary">readContentBinary</a></li><li><a href="global.html#readContentFormat">readContentFormat</a></li><li><a href="global.html#readItemContent">readItemContent</a></li><li><a href="global.html#readRelativePosition">readRelativePosition</a></li><li><a href="global.html#readYXmlElement">readYXmlElement</a></li><li><a href="global.html#refreshMarkerTimestamp">refreshMarkerTimestamp</a></li><li><a href="global.html#snapshot">snapshot</a></li><li><a href="global.html#splitSnapshotAffectedStructs">splitSnapshotAffectedStructs</a></li><li><a href="global.html#transact">transact</a></li><li><a href="global.html#tryGc">tryGc</a></li><li><a href="global.html#tryGcDeleteSet">tryGcDeleteSet</a></li><li><a href="global.html#tryMergeDeleteSet">tryMergeDeleteSet</a></li><li><a href="global.html#tryToMergeWithLeft">tryToMergeWithLeft</a></li><li class="hidden"><a href="global.html#UndoManagerOptions">UndoManagerOptions</a></li><li><a href="global.html#updateMarkerChanges">updateMarkerChanges</a></li><li><a href="global.html#writeRelativePosition">writeRelativePosition</a></li><li><a href="global.html#writeUpdateMessageFromTransaction">writeUpdateMessageFromTransaction</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
/**
 * @module YText
 */

import {
  YEvent,
  AbstractType,
  getItemCleanStart,
  getState,
  isVisible,
  createID,
  YTextRefID,
  callTypeObservers,
  transact,
  ContentEmbed,
  GC,
  ContentFormat,
  ContentString,
  splitSnapshotAffectedStructs,
  iterateDeletedStructs,
  iterateStructs,
  findMarker,
  typeMapDelete,
  typeMapSet,
  typeMapGet,
  typeMapGetAll,
  updateMarkerChanges,
  ArraySearchMarker, AbstractUpdateDecoder, AbstractUpdateEncoder, ID, Doc, Item, Snapshot, Transaction // eslint-disable-line
} from '../internals.js'

import * as object from 'lib0/object.js'
import * as map from 'lib0/map.js'
import * as error from 'lib0/error.js'

/**
 * @param {any} a
 * @param {any} b
 * @return {boolean}
 */
const equalAttrs = (a, b) => a === b || (typeof a === 'object' &amp;&amp; typeof b === 'object' &amp;&amp; a &amp;&amp; b &amp;&amp; object.equalFlat(a, b))

export class ItemTextListPosition {
  /**
   * @param {Item|null} left
   * @param {Item|null} right
   * @param {number} index
   * @param {Map&lt;string,any>} currentAttributes
   */
  constructor (left, right, index, currentAttributes) {
    this.left = left
    this.right = right
    this.index = index
    this.currentAttributes = currentAttributes
  }

  /**
   * Only call this if you know that this.right is defined
   */
  forward () {
    if (this.right === null) {
      error.unexpectedCase()
    }
    switch (this.right.content.constructor) {
      case ContentEmbed:
      case ContentString:
        if (!this.right.deleted) {
          this.index += this.right.length
        }
        break
      case ContentFormat:
        if (!this.right.deleted) {
          updateCurrentAttributes(this.currentAttributes, /** @type {ContentFormat} */ (this.right.content))
        }
        break
    }
    this.left = this.right
    this.right = this.right.right
  }
}

/**
 * @param {Transaction} transaction
 * @param {ItemTextListPosition} pos
 * @param {number} count steps to move forward
 * @return {ItemTextListPosition}
 *
 * @private
 * @function
 */
const findNextPosition = (transaction, pos, count) => {
  while (pos.right !== null &amp;&amp; count > 0) {
    switch (pos.right.content.constructor) {
      case ContentEmbed:
      case ContentString:
        if (!pos.right.deleted) {
          if (count &lt; pos.right.length) {
            // split right
            getItemCleanStart(transaction, createID(pos.right.id.client, pos.right.id.clock + count))
          }
          pos.index += pos.right.length
          count -= pos.right.length
        }
        break
      case ContentFormat:
        if (!pos.right.deleted) {
          updateCurrentAttributes(pos.currentAttributes, /** @type {ContentFormat} */ (pos.right.content))
        }
        break
    }
    pos.left = pos.right
    pos.right = pos.right.right
    // pos.forward() - we don't forward because that would halve the performance because we already do the checks above
  }
  return pos
}

/**
 * @param {Transaction} transaction
 * @param {AbstractType&lt;any>} parent
 * @param {number} index
 * @return {ItemTextListPosition}
 *
 * @private
 * @function
 */
const findPosition = (transaction, parent, index) => {
  const currentAttributes = new Map()
  const marker = findMarker(parent, index)
  if (marker) {
    const pos = new ItemTextListPosition(marker.p.left, marker.p, marker.index, currentAttributes)
    return findNextPosition(transaction, pos, index - marker.index)
  } else {
    const pos = new ItemTextListPosition(null, parent._start, 0, currentAttributes)
    return findNextPosition(transaction, pos, index)
  }
}

/**
 * Negate applied formats
 *
 * @param {Transaction} transaction
 * @param {AbstractType&lt;any>} parent
 * @param {ItemTextListPosition} currPos
 * @param {Map&lt;string,any>} negatedAttributes
 *
 * @private
 * @function
 */
const insertNegatedAttributes = (transaction, parent, currPos, negatedAttributes) => {
  // check if we really need to remove attributes
  while (
    currPos.right !== null &amp;&amp; (
      currPos.right.deleted === true || (
        currPos.right.content.constructor === ContentFormat &amp;&amp;
        equalAttrs(negatedAttributes.get(/** @type {ContentFormat} */ (currPos.right.content).key), /** @type {ContentFormat} */ (currPos.right.content).value)
      )
    )
  ) {
    if (!currPos.right.deleted) {
      negatedAttributes.delete(/** @type {ContentFormat} */ (currPos.right.content).key)
    }
    currPos.forward()
  }
  const doc = transaction.doc
  const ownClientId = doc.clientID
  let left = currPos.left
  const right = currPos.right
  negatedAttributes.forEach((val, key) => {
    left = new Item(createID(ownClientId, getState(doc.store, ownClientId)), left, left &amp;&amp; left.lastId, right, right &amp;&amp; right.id, parent, null, new ContentFormat(key, val))
    left.integrate(transaction, 0)
    currPos.currentAttributes.set(key, val)
    updateCurrentAttributes(currPos.currentAttributes, /** @type {ContentFormat} */ (left.content))
  })
}

/**
 * @param {Map&lt;string,any>} currentAttributes
 * @param {ContentFormat} format
 *
 * @private
 * @function
 */
const updateCurrentAttributes = (currentAttributes, format) => {
  const { key, value } = format
  if (value === null) {
    currentAttributes.delete(key)
  } else {
    currentAttributes.set(key, value)
  }
}

/**
 * @param {ItemTextListPosition} currPos
 * @param {Object&lt;string,any>} attributes
 *
 * @private
 * @function
 */
const minimizeAttributeChanges = (currPos, attributes) => {
  // go right while attributes[right.key] === right.value (or right is deleted)
  while (true) {
    if (currPos.right === null) {
      break
    } else if (currPos.right.deleted || (currPos.right.content.constructor === ContentFormat &amp;&amp; equalAttrs(attributes[(/** @type {ContentFormat} */ (currPos.right.content)).key] || null, /** @type {ContentFormat} */ (currPos.right.content).value))) {
      //
    } else {
      break
    }
    currPos.forward()
  }
}

/**
 * @param {Transaction} transaction
 * @param {AbstractType&lt;any>} parent
 * @param {ItemTextListPosition} currPos
 * @param {Object&lt;string,any>} attributes
 * @return {Map&lt;string,any>}
 *
 * @private
 * @function
 **/
const insertAttributes = (transaction, parent, currPos, attributes) => {
  const doc = transaction.doc
  const ownClientId = doc.clientID
  const negatedAttributes = new Map()
  // insert format-start items
  for (const key in attributes) {
    const val = attributes[key]
    const currentVal = currPos.currentAttributes.get(key) || null
    if (!equalAttrs(currentVal, val)) {
      // save negated attribute (set null if currentVal undefined)
      negatedAttributes.set(key, currentVal)
      const { left, right } = currPos
      currPos.right = new Item(createID(ownClientId, getState(doc.store, ownClientId)), left, left &amp;&amp; left.lastId, right, right &amp;&amp; right.id, parent, null, new ContentFormat(key, val))
      currPos.right.integrate(transaction, 0)
      currPos.forward()
    }
  }
  return negatedAttributes
}

/**
 * @param {Transaction} transaction
 * @param {AbstractType&lt;any>} parent
 * @param {ItemTextListPosition} currPos
 * @param {string|object} text
 * @param {Object&lt;string,any>} attributes
 *
 * @private
 * @function
 **/
const insertText = (transaction, parent, currPos, text, attributes) => {
  currPos.currentAttributes.forEach((val, key) => {
    if (attributes[key] === undefined) {
      attributes[key] = null
    }
  })
  const doc = transaction.doc
  const ownClientId = doc.clientID
  minimizeAttributeChanges(currPos, attributes)
  const negatedAttributes = insertAttributes(transaction, parent, currPos, attributes)
  // insert content
  const content = text.constructor === String ? new ContentString(/** @type {string} */ (text)) : new ContentEmbed(text)
  let { left, right, index } = currPos
  if (parent._searchMarker) {
    updateMarkerChanges(parent._searchMarker, currPos.index, content.getLength())
  }
  right = new Item(createID(ownClientId, getState(doc.store, ownClientId)), left, left &amp;&amp; left.lastId, right, right &amp;&amp; right.id, parent, null, content)
  right.integrate(transaction, 0)
  currPos.right = right
  currPos.index = index
  currPos.forward()
  insertNegatedAttributes(transaction, parent, currPos, negatedAttributes)
}

/**
 * @param {Transaction} transaction
 * @param {AbstractType&lt;any>} parent
 * @param {ItemTextListPosition} currPos
 * @param {number} length
 * @param {Object&lt;string,any>} attributes
 *
 * @private
 * @function
 */
const formatText = (transaction, parent, currPos, length, attributes) => {
  const doc = transaction.doc
  const ownClientId = doc.clientID
  minimizeAttributeChanges(currPos, attributes)
  const negatedAttributes = insertAttributes(transaction, parent, currPos, attributes)
  // iterate until first non-format or null is found
  // delete all formats with attributes[format.key] != null
  while (length > 0 &amp;&amp; currPos.right !== null) {
    if (!currPos.right.deleted) {
      switch (currPos.right.content.constructor) {
        case ContentFormat: {
          const { key, value } = /** @type {ContentFormat} */ (currPos.right.content)
          const attr = attributes[key]
          if (attr !== undefined) {
            if (equalAttrs(attr, value)) {
              negatedAttributes.delete(key)
            } else {
              negatedAttributes.set(key, value)
            }
            currPos.right.delete(transaction)
          }
          break
        }
        case ContentEmbed:
        case ContentString:
          if (length &lt; currPos.right.length) {
            getItemCleanStart(transaction, createID(currPos.right.id.client, currPos.right.id.clock + length))
          }
          length -= currPos.right.length
          break
      }
    }
    currPos.forward()
  }
  // Quill just assumes that the editor starts with a newline and that it always
  // ends with a newline. We only insert that newline when a new newline is
  // inserted - i.e when length is bigger than type.length
  if (length > 0) {
    let newlines = ''
    for (; length > 0; length--) {
      newlines += '\n'
    }
    currPos.right = new Item(createID(ownClientId, getState(doc.store, ownClientId)), currPos.left, currPos.left &amp;&amp; currPos.left.lastId, currPos.right, currPos.right &amp;&amp; currPos.right.id, parent, null, new ContentString(newlines))
    currPos.right.integrate(transaction, 0)
    currPos.forward()
  }
  insertNegatedAttributes(transaction, parent, currPos, negatedAttributes)
}

/**
 * Call this function after string content has been deleted in order to
 * clean up formatting Items.
 *
 * @param {Transaction} transaction
 * @param {Item} start
 * @param {Item|null} end exclusive end, automatically iterates to the next Content Item
 * @param {Map&lt;string,any>} startAttributes
 * @param {Map&lt;string,any>} endAttributes This attribute is modified!
 * @return {number} The amount of formatting Items deleted.
 *
 * @function
 */
const cleanupFormattingGap = (transaction, start, end, startAttributes, endAttributes) => {
  while (end &amp;&amp; end.content.constructor !== ContentString &amp;&amp; end.content.constructor !== ContentEmbed) {
    if (!end.deleted &amp;&amp; end.content.constructor === ContentFormat) {
      updateCurrentAttributes(endAttributes, /** @type {ContentFormat} */ (end.content))
    }
    end = end.right
  }
  let cleanups = 0
  while (start !== end) {
    if (!start.deleted) {
      const content = start.content
      switch (content.constructor) {
        case ContentFormat: {
          const { key, value } = /** @type {ContentFormat} */ (content)
          if ((endAttributes.get(key) || null) !== value || (startAttributes.get(key) || null) === value) {
            // Either this format is overwritten or it is not necessary because the attribute already existed.
            start.delete(transaction)
            cleanups++
          }
          break
        }
      }
    }
    start = /** @type {Item} */ (start.right)
  }
  return cleanups
}

/**
 * @param {Transaction} transaction
 * @param {Item | null} item
 */
const cleanupContextlessFormattingGap = (transaction, item) => {
  // iterate until item.right is null or content
  while (item &amp;&amp; item.right &amp;&amp; (item.right.deleted || (item.right.content.constructor !== ContentString &amp;&amp; item.right.content.constructor !== ContentEmbed))) {
    item = item.right
  }
  const attrs = new Set()
  // iterate back until a content item is found
  while (item &amp;&amp; (item.deleted || (item.content.constructor !== ContentString &amp;&amp; item.content.constructor !== ContentEmbed))) {
    if (!item.deleted &amp;&amp; item.content.constructor === ContentFormat) {
      const key = /** @type {ContentFormat} */ (item.content).key
      if (attrs.has(key)) {
        item.delete(transaction)
      } else {
        attrs.add(key)
      }
    }
    item = item.left
  }
}

/**
 * This function is experimental and subject to change / be removed.
 *
 * Ideally, we don't need this function at all. Formatting attributes should be cleaned up
 * automatically after each change. This function iterates twice over the complete YText type
 * and removes unnecessary formatting attributes. This is also helpful for testing.
 *
 * This function won't be exported anymore as soon as there is confidence that the YText type works as intended.
 *
 * @param {YText} type
 * @return {number} How many formatting attributes have been cleaned up.
 */
export const cleanupYTextFormatting = type => {
  let res = 0
  transact(/** @type {Doc} */ (type.doc), transaction => {
    let start = /** @type {Item} */ (type._start)
    let end = type._start
    let startAttributes = map.create()
    const currentAttributes = map.copy(startAttributes)
    while (end) {
      if (end.deleted === false) {
        switch (end.content.constructor) {
          case ContentFormat:
            updateCurrentAttributes(currentAttributes, /** @type {ContentFormat} */ (end.content))
            break
          case ContentEmbed:
          case ContentString:
            res += cleanupFormattingGap(transaction, start, end, startAttributes, currentAttributes)
            startAttributes = map.copy(currentAttributes)
            start = end
            break
        }
      }
      end = end.right
    }
  })
  return res
}

/**
 * @param {Transaction} transaction
 * @param {ItemTextListPosition} currPos
 * @param {number} length
 * @return {ItemTextListPosition}
 *
 * @private
 * @function
 */
const deleteText = (transaction, currPos, length) => {
  const startLength = length
  const startAttrs = map.copy(currPos.currentAttributes)
  const start = currPos.right
  while (length > 0 &amp;&amp; currPos.right !== null) {
    if (currPos.right.deleted === false) {
      switch (currPos.right.content.constructor) {
        case ContentEmbed:
        case ContentString:
          if (length &lt; currPos.right.length) {
            getItemCleanStart(transaction, createID(currPos.right.id.client, currPos.right.id.clock + length))
          }
          length -= currPos.right.length
          currPos.right.delete(transaction)
          break
      }
    }
    currPos.forward()
  }
  if (start) {
    cleanupFormattingGap(transaction, start, currPos.right, startAttrs, map.copy(currPos.currentAttributes))
  }
  const parent = /** @type {AbstractType&lt;any>} */ (/** @type {Item} */ (currPos.left || currPos.right).parent)
  if (parent._searchMarker) {
    updateMarkerChanges(parent._searchMarker, currPos.index, -startLength + length)
  }
  return currPos
}

/**
 * The Quill Delta format represents changes on a text document with
 * formatting information. For mor information visit {@link https://quilljs.com/docs/delta/|Quill Delta}
 *
 * @example
 *   {
 *     ops: [
 *       { insert: 'Gandalf', attributes: { bold: true } },
 *       { insert: ' the ' },
 *       { insert: 'Grey', attributes: { color: '#cccccc' } }
 *     ]
 *   }
 *
 */

/**
  * Attributes that can be assigned to a selection of text.
  *
  * @example
  *   {
  *     bold: true,
  *     font-size: '40px'
  *   }
  *
  * @typedef {Object} TextAttributes
  */

/**
 * @typedef {Object} DeltaItem
 * @property {number|undefined} DeltaItem.delete
 * @property {number|undefined} DeltaItem.retain
 * @property {string|undefined} DeltaItem.insert
 * @property {Object&lt;string,any>} DeltaItem.attributes
 */

/**
 * Event that describes the changes on a YText type.
 */
export class YTextEvent extends YEvent {
  /**
   * @param {YText} ytext
   * @param {Transaction} transaction
   * @param {Set&lt;any>} subs The keys that changed
   */
  constructor (ytext, transaction, subs) {
    super(ytext, transaction)
    /**
     * @type {Array&lt;DeltaItem>|null}
     */
    this._delta = null
    /**
     * Whether the children changed.
     * @type {Boolean}
     * @private
     */
    this.childListChanged = false
    /**
     * Set of all changed attributes.
     * @type {Set&lt;string>}
     */
    this.keysChanged = new Set()
    subs.forEach((sub) => {
      if (sub === null) {
        this.childListChanged = true
      } else {
        this.keysChanged.add(sub)
      }
    })
  }

  /**
   * Compute the changes in the delta format.
   * A {@link https://quilljs.com/docs/delta/|Quill Delta}) that represents the changes on the document.
   *
   * @type {Array&lt;DeltaItem>}
   *
   * @public
   */
  get delta () {
    if (this._delta === null) {
      const y = /** @type {Doc} */ (this.target.doc)
      this._delta = []
      transact(y, transaction => {
        const delta = /** @type {Array&lt;DeltaItem>} */ (this._delta)
        const currentAttributes = new Map() // saves all current attributes for insert
        const oldAttributes = new Map()
        let item = this.target._start
        /**
         * @type {string?}
         */
        let action = null
        /**
         * @type {Object&lt;string,any>}
         */
        const attributes = {} // counts added or removed new attributes for retain
        /**
         * @type {string|object}
         */
        let insert = ''
        let retain = 0
        let deleteLen = 0
        const addOp = () => {
          if (action !== null) {
            /**
             * @type {any}
             */
            let op
            switch (action) {
              case 'delete':
                op = { delete: deleteLen }
                deleteLen = 0
                break
              case 'insert':
                op = { insert }
                if (currentAttributes.size > 0) {
                  op.attributes = {}
                  currentAttributes.forEach((value, key) => {
                    if (value !== null) {
                      op.attributes[key] = value
                    }
                  })
                }
                insert = ''
                break
              case 'retain':
                op = { retain }
                if (Object.keys(attributes).length > 0) {
                  op.attributes = {}
                  for (const key in attributes) {
                    op.attributes[key] = attributes[key]
                  }
                }
                retain = 0
                break
            }
            delta.push(op)
            action = null
          }
        }
        while (item !== null) {
          switch (item.content.constructor) {
            case ContentEmbed:
              if (this.adds(item)) {
                if (!this.deletes(item)) {
                  addOp()
                  action = 'insert'
                  insert = /** @type {ContentEmbed} */ (item.content).embed
                  addOp()
                }
              } else if (this.deletes(item)) {
                if (action !== 'delete') {
                  addOp()
                  action = 'delete'
                }
                deleteLen += 1
              } else if (!item.deleted) {
                if (action !== 'retain') {
                  addOp()
                  action = 'retain'
                }
                retain += 1
              }
              break
            case ContentString:
              if (this.adds(item)) {
                if (!this.deletes(item)) {
                  if (action !== 'insert') {
                    addOp()
                    action = 'insert'
                  }
                  insert += /** @type {ContentString} */ (item.content).str
                }
              } else if (this.deletes(item)) {
                if (action !== 'delete') {
                  addOp()
                  action = 'delete'
                }
                deleteLen += item.length
              } else if (!item.deleted) {
                if (action !== 'retain') {
                  addOp()
                  action = 'retain'
                }
                retain += item.length
              }
              break
            case ContentFormat: {
              const { key, value } = /** @type {ContentFormat} */ (item.content)
              if (this.adds(item)) {
                if (!this.deletes(item)) {
                  const curVal = currentAttributes.get(key) || null
                  if (!equalAttrs(curVal, value)) {
                    if (action === 'retain') {
                      addOp()
                    }
                    if (equalAttrs(value, (oldAttributes.get(key) || null))) {
                      delete attributes[key]
                    } else {
                      attributes[key] = value
                    }
                  } else {
                    item.delete(transaction)
                  }
                }
              } else if (this.deletes(item)) {
                oldAttributes.set(key, value)
                const curVal = currentAttributes.get(key) || null
                if (!equalAttrs(curVal, value)) {
                  if (action === 'retain') {
                    addOp()
                  }
                  attributes[key] = curVal
                }
              } else if (!item.deleted) {
                oldAttributes.set(key, value)
                const attr = attributes[key]
                if (attr !== undefined) {
                  if (!equalAttrs(attr, value)) {
                    if (action === 'retain') {
                      addOp()
                    }
                    if (value === null) {
                      attributes[key] = value
                    } else {
                      delete attributes[key]
                    }
                  } else {
                    item.delete(transaction)
                  }
                }
              }
              if (!item.deleted) {
                if (action === 'insert') {
                  addOp()
                }
                updateCurrentAttributes(currentAttributes, /** @type {ContentFormat} */ (item.content))
              }
              break
            }
          }
          item = item.right
        }
        addOp()
        while (delta.length > 0) {
          const lastOp = delta[delta.length - 1]
          if (lastOp.retain !== undefined &amp;&amp; lastOp.attributes === undefined) {
            // retain delta's if they don't assign attributes
            delta.pop()
          } else {
            break
          }
        }
      })
    }
    return this._delta
  }
}

/**
 * Type that represents text with formatting information.
 *
 * This type replaces y-richtext as this implementation is able to handle
 * block formats (format information on a paragraph), embeds (complex elements
 * like pictures and videos), and text formats (**bold**, *italic*).
 *
 * @extends AbstractType&lt;YTextEvent>
 */
export class YText extends AbstractType {
  /**
   * @param {String} [string] The initial value of the YText.
   */
  constructor (string) {
    super()
    /**
     * Array of pending operations on this type
     * @type {Array&lt;function():void>?}
     */
    this._pending = string !== undefined ? [() => this.insert(0, string)] : []
    /**
     * @type {Array&lt;ArraySearchMarker>}
     */
    this._searchMarker = []
  }

  /**
   * Number of characters of this text type.
   *
   * @type {number}
   */
  get length () {
    return this._length
  }

  /**
   * @param {Doc} y
   * @param {Item} item
   */
  _integrate (y, item) {
    super._integrate(y, item)
    try {
      /** @type {Array&lt;function>} */ (this._pending).forEach(f => f())
    } catch (e) {
      console.error(e)
    }
    this._pending = null
  }

  _copy () {
    return new YText()
  }

  /**
   * @return {YText}
   */
  clone () {
    const text = new YText()
    text.applyDelta(this.toDelta())
    return text
  }

  /**
   * Creates YTextEvent and calls observers.
   *
   * @param {Transaction} transaction
   * @param {Set&lt;null|string>} parentSubs Keys changed on this type. `null` if list was modified.
   */
  _callObserver (transaction, parentSubs) {
    super._callObserver(transaction, parentSubs)
    const event = new YTextEvent(this, transaction, parentSubs)
    const doc = transaction.doc
    // If a remote change happened, we try to cleanup potential formatting duplicates.
    if (!transaction.local) {
      // check if another formatting item was inserted
      let foundFormattingItem = false
      for (const [client, afterClock] of transaction.afterState.entries()) {
        const clock = transaction.beforeState.get(client) || 0
        if (afterClock === clock) {
          continue
        }
        iterateStructs(transaction, /** @type {Array&lt;Item|GC>} */ (doc.store.clients.get(client)), clock, afterClock, item => {
          if (!item.deleted &amp;&amp; /** @type {Item} */ (item).content.constructor === ContentFormat) {
            foundFormattingItem = true
          }
        })
        if (foundFormattingItem) {
          break
        }
      }
      if (!foundFormattingItem) {
        iterateDeletedStructs(transaction, transaction.deleteSet, item => {
          if (item instanceof GC || foundFormattingItem) {
            return
          }
          if (item.parent === this &amp;&amp; item.content.constructor === ContentFormat) {
            foundFormattingItem = true
          }
        })
      }
      transact(doc, (t) => {
        if (foundFormattingItem) {
          // If a formatting item was inserted, we simply clean the whole type.
          // We need to compute currentAttributes for the current position anyway.
          cleanupYTextFormatting(this)
        } else {
          // If no formatting attribute was inserted, we can make due with contextless
          // formatting cleanups.
          // Contextless: it is not necessary to compute currentAttributes for the affected position.
          iterateDeletedStructs(t, t.deleteSet, item => {
            if (item instanceof GC) {
              return
            }
            if (item.parent === this) {
              cleanupContextlessFormattingGap(t, item)
            }
          })
        }
      })
    }
    callTypeObservers(this, transaction, event)
  }

  /**
   * Returns the unformatted string representation of this YText type.
   *
   * @public
   */
  toString () {
    let str = ''
    /**
     * @type {Item|null}
     */
    let n = this._start
    while (n !== null) {
      if (!n.deleted &amp;&amp; n.countable &amp;&amp; n.content.constructor === ContentString) {
        str += /** @type {ContentString} */ (n.content).str
      }
      n = n.right
    }
    return str
  }

  /**
   * Returns the unformatted string representation of this YText type.
   *
   * @return {string}
   * @public
   */
  toJSON () {
    return this.toString()
  }

  /**
   * Apply a {@link Delta} on this shared YText type.
   *
   * @param {any} delta The changes to apply on this element.
   * @param {object}  [opts]
   * @param {boolean} [opts.sanitize] Sanitize input delta. Removes ending newlines if set to true.
   *
   *
   * @public
   */
  applyDelta (delta, { sanitize = true } = {}) {
    if (this.doc !== null) {
      transact(this.doc, transaction => {
        const currPos = new ItemTextListPosition(null, this._start, 0, new Map())
        for (let i = 0; i &lt; delta.length; i++) {
          const op = delta[i]
          if (op.insert !== undefined) {
            // Quill assumes that the content starts with an empty paragraph.
            // Yjs/Y.Text assumes that it starts empty. We always hide that
            // there is a newline at the end of the content.
            // If we omit this step, clients will see a different number of
            // paragraphs, but nothing bad will happen.
            const ins = (!sanitize &amp;&amp; typeof op.insert === 'string' &amp;&amp; i === delta.length - 1 &amp;&amp; currPos.right === null &amp;&amp; op.insert.slice(-1) === '\n') ? op.insert.slice(0, -1) : op.insert
            if (typeof ins !== 'string' || ins.length > 0) {
              insertText(transaction, this, currPos, ins, op.attributes || {})
            }
          } else if (op.retain !== undefined) {
            formatText(transaction, this, currPos, op.retain, op.attributes || {})
          } else if (op.delete !== undefined) {
            deleteText(transaction, currPos, op.delete)
          }
        }
      })
    } else {
      /** @type {Array&lt;function>} */ (this._pending).push(() => this.applyDelta(delta))
    }
  }

  /**
   * Returns the Delta representation of this YText type.
   *
   * @param {Snapshot} [snapshot]
   * @param {Snapshot} [prevSnapshot]
   * @param {function('removed' | 'added', ID):any} [computeYChange]
   * @return {any} The Delta representation of this type.
   *
   * @public
   */
  toDelta (snapshot, prevSnapshot, computeYChange) {
    /**
     * @type{Array&lt;any>}
     */
    const ops = []
    const currentAttributes = new Map()
    const doc = /** @type {Doc} */ (this.doc)
    let str = ''
    let n = this._start
    function packStr () {
      if (str.length > 0) {
        // pack str with attributes to ops
        /**
         * @type {Object&lt;string,any>}
         */
        const attributes = {}
        let addAttributes = false
        currentAttributes.forEach((value, key) => {
          addAttributes = true
          attributes[key] = value
        })
        /**
         * @type {Object&lt;string,any>}
         */
        const op = { insert: str }
        if (addAttributes) {
          op.attributes = attributes
        }
        ops.push(op)
        str = ''
      }
    }
    // snapshots are merged again after the transaction, so we need to keep the
    // transalive until we are done
    transact(doc, transaction => {
      if (snapshot) {
        splitSnapshotAffectedStructs(transaction, snapshot)
      }
      if (prevSnapshot) {
        splitSnapshotAffectedStructs(transaction, prevSnapshot)
      }
      while (n !== null) {
        if (isVisible(n, snapshot) || (prevSnapshot !== undefined &amp;&amp; isVisible(n, prevSnapshot))) {
          switch (n.content.constructor) {
            case ContentString: {
              const cur = currentAttributes.get('ychange')
              if (snapshot !== undefined &amp;&amp; !isVisible(n, snapshot)) {
                if (cur === undefined || cur.user !== n.id.client || cur.state !== 'removed') {
                  packStr()
                  currentAttributes.set('ychange', computeYChange ? computeYChange('removed', n.id) : { type: 'removed' })
                }
              } else if (prevSnapshot !== undefined &amp;&amp; !isVisible(n, prevSnapshot)) {
                if (cur === undefined || cur.user !== n.id.client || cur.state !== 'added') {
                  packStr()
                  currentAttributes.set('ychange', computeYChange ? computeYChange('added', n.id) : { type: 'added' })
                }
              } else if (cur !== undefined) {
                packStr()
                currentAttributes.delete('ychange')
              }
              str += /** @type {ContentString} */ (n.content).str
              break
            }
            case ContentEmbed: {
              packStr()
              /**
               * @type {Object&lt;string,any>}
               */
              const op = {
                insert: /** @type {ContentEmbed} */ (n.content).embed
              }
              if (currentAttributes.size > 0) {
                const attrs = /** @type {Object&lt;string,any>} */ ({})
                op.attributes = attrs
                currentAttributes.forEach((value, key) => {
                  attrs[key] = value
                })
              }
              ops.push(op)
              break
            }
            case ContentFormat:
              if (isVisible(n, snapshot)) {
                packStr()
                updateCurrentAttributes(currentAttributes, /** @type {ContentFormat} */ (n.content))
              }
              break
          }
        }
        n = n.right
      }
      packStr()
    }, splitSnapshotAffectedStructs)
    return ops
  }

  /**
   * Insert text at a given index.
   *
   * @param {number} index The index at which to start inserting.
   * @param {String} text The text to insert at the specified position.
   * @param {TextAttributes} [attributes] Optionally define some formatting
   *                                    information to apply on the inserted
   *                                    Text.
   * @public
   */
  insert (index, text, attributes) {
    if (text.length &lt;= 0) {
      return
    }
    const y = this.doc
    if (y !== null) {
      transact(y, transaction => {
        const pos = findPosition(transaction, this, index)
        if (!attributes) {
          attributes = {}
          // @ts-ignore
          pos.currentAttributes.forEach((v, k) => { attributes[k] = v })
        }
        insertText(transaction, this, pos, text, attributes)
      })
    } else {
      /** @type {Array&lt;function>} */ (this._pending).push(() => this.insert(index, text, attributes))
    }
  }

  /**
   * Inserts an embed at a index.
   *
   * @param {number} index The index to insert the embed at.
   * @param {Object} embed The Object that represents the embed.
   * @param {TextAttributes} attributes Attribute information to apply on the
   *                                    embed
   *
   * @public
   */
  insertEmbed (index, embed, attributes = {}) {
    if (embed.constructor !== Object) {
      throw new Error('Embed must be an Object')
    }
    const y = this.doc
    if (y !== null) {
      transact(y, transaction => {
        const pos = findPosition(transaction, this, index)
        insertText(transaction, this, pos, embed, attributes)
      })
    } else {
      /** @type {Array&lt;function>} */ (this._pending).push(() => this.insertEmbed(index, embed, attributes))
    }
  }

  /**
   * Deletes text starting from an index.
   *
   * @param {number} index Index at which to start deleting.
   * @param {number} length The number of characters to remove. Defaults to 1.
   *
   * @public
   */
  delete (index, length) {
    if (length === 0) {
      return
    }
    const y = this.doc
    if (y !== null) {
      transact(y, transaction => {
        deleteText(transaction, findPosition(transaction, this, index), length)
      })
    } else {
      /** @type {Array&lt;function>} */ (this._pending).push(() => this.delete(index, length))
    }
  }

  /**
   * Assigns properties to a range of text.
   *
   * @param {number} index The position where to start formatting.
   * @param {number} length The amount of characters to assign properties to.
   * @param {TextAttributes} attributes Attribute information to apply on the
   *                                    text.
   *
   * @public
   */
  format (index, length, attributes) {
    if (length === 0) {
      return
    }
    const y = this.doc
    if (y !== null) {
      transact(y, transaction => {
        const pos = findPosition(transaction, this, index)
        if (pos.right === null) {
          return
        }
        formatText(transaction, this, pos, length, attributes)
      })
    } else {
      /** @type {Array&lt;function>} */ (this._pending).push(() => this.format(index, length, attributes))
    }
  }

  /**
   * Removes an attribute.
   *
   * @note Xml-Text nodes don't have attributes. You can use this feature to assign properties to complete text-blocks.
   *
   * @param {String} attributeName The attribute name that is to be removed.
   *
   * @public
   */
  removeAttribute (attributeName) {
    if (this.doc !== null) {
      transact(this.doc, transaction => {
        typeMapDelete(transaction, this, attributeName)
      })
    } else {
      /** @type {Array&lt;function>} */ (this._pending).push(() => this.removeAttribute(attributeName))
    }
  }

  /**
   * Sets or updates an attribute.
   *
   * @note Xml-Text nodes don't have attributes. You can use this feature to assign properties to complete text-blocks.
   *
   * @param {String} attributeName The attribute name that is to be set.
   * @param {any} attributeValue The attribute value that is to be set.
   *
   * @public
   */
  setAttribute (attributeName, attributeValue) {
    if (this.doc !== null) {
      transact(this.doc, transaction => {
        typeMapSet(transaction, this, attributeName, attributeValue)
      })
    } else {
      /** @type {Array&lt;function>} */ (this._pending).push(() => this.setAttribute(attributeName, attributeValue))
    }
  }

  /**
   * Returns an attribute value that belongs to the attribute name.
   *
   * @note Xml-Text nodes don't have attributes. You can use this feature to assign properties to complete text-blocks.
   *
   * @param {String} attributeName The attribute name that identifies the
   *                               queried value.
   * @return {any} The queried attribute value.
   *
   * @public
   */
  getAttribute (attributeName) {
    return /** @type {any} */ (typeMapGet(this, attributeName))
  }

  /**
   * Returns all attribute name/value pairs in a JSON Object.
   *
   * @note Xml-Text nodes don't have attributes. You can use this feature to assign properties to complete text-blocks.
   *
   * @param {Snapshot} [snapshot]
   * @return {Object&lt;string, any>} A JSON Object that describes the attributes.
   *
   * @public
   */
  getAttributes (snapshot) {
    return typeMapGetAll(this)
  }

  /**
   * @param {AbstractUpdateEncoder} encoder
   */
  _write (encoder) {
    encoder.writeTypeRef(YTextRefID)
  }
}

/**
 * @param {AbstractUpdateDecoder} decoder
 * @return {YText}
 *
 * @private
 * @function
 */
export const readYText = decoder => new YText()
</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="https://yjs.dev/images/logo/yjs-512x512.png" style="width: 162px; height: 162px">
    <div class="footer-text">Shared Editing</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
